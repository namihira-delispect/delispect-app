# テストガイドライン

## 1. 概要

本ドキュメントは、テスト方針と規約を定義する。

### 関連ドキュメント

- [コーディングガイドライン](./coding-guidelines.md) - コード規約

---

## 2. テスト方針

### 2.1 テストピラミッド

- **単体テスト**: ビジネスロジック関数、ユーティリティ関数
- **統合テスト**: Server Actions、データアクセス層（実DB使用）
- **E2Eテスト**: 重要なユーザーフロー（Playwright使用）

### 2.2 データアクセス層のテスト

**原則: モックではなく実際のテスト用DBを使用する**

理由:
- 実際のSQLクエリの動作を確認できる
- 外部キー制約などのDB制約を検証できる
- モックとの乖離によるバグを防止できる

---

## 3. テスト観点ガイド

チケット作成時にテスト観点を定義する際の基準。

### 3.1 テスト種別の選定基準

| テスト種別 | 対象 | 作成基準 |
|-----------|------|---------|
| 単体テスト | ビジネスロジック、ユーティリティ関数、型変換 | 原則すべて作成 |
| 統合テスト | Server Actions、リポジトリ層、複数モジュール連携 | DB操作・外部連携を含む場合に作成 |
| E2Eテスト | ユーザーフロー | 重要な業務フロー・クリティカルパスに限定 |

### 3.2 テストケースの観点

#### 正常系

以下の観点でケースを設計する:

| 観点 | 例 |
|------|-----|
| 基本動作 | 標準的な入力で期待する結果が返る |
| 境界値 | 最小値、最大値、空リスト、1件のみ |
| バリエーション | 複数のパターン（権限別、ステータス別など）。組み合わせがある場合は、全網羅・ペアワイズ・同値分割等から最適な手法を選択 |

#### 異常系

以下の基準に該当する場合にケースを作成する:

| 観点 | 例 | 作成基準 |
|------|-----|---------|
| バリデーションエラー | 必須項目未入力、型不正、範囲外の値 | バリデーションロジックがある場合は必須 |
| 存在しないリソース | 該当IDが見つからない | DB参照を行う場合は必須 |
| 認証・認可エラー | 未認証、権限不足 | 認証・認可チェックがある場合は必須 |
| 外部サービスエラー | API呼び出し失敗、タイムアウト | 外部連携がある場合は必須 |
| データ不整合 | 想定外の状態のデータ | クリティカルな業務ロジックの場合に作成 |

### 3.3 テスト観点の定義プロセス

1. 開発者がチケット作成時に[チケットテンプレート](../templates/ticket.md)のテスト観点セクションに記載
2. 事前レビューでPdM/PdOがテスト観点の網羅性を確認
3. エージェントはチケットに記載されたテスト観点に基づいてテストを作成

> チケットに記載されていないテストをエージェントが追加することを防ぎ、テストの品質と範囲を管理する。

---

## 4. テスト環境

### 4.1 ツールスタック

| ツール | 用途 |
|--------|------|
| Vitest | テストランナー（単体・統合テスト） |
| Playwright | E2Eテスト |

### 4.2 テスト用インフラ

| コンポーネント | ポート | 用途 |
|--------------|--------|------|
| PostgreSQL | 5433 | テスト用DB |

```bash
docker compose -f docker-compose.test.yml up -d
```

---

## 5. ディレクトリ構造

### 5.1 単体・統合テスト

```
packages/{package}/
├── src/
│   └── utils/
│       └── date.ts
└── tests/
    └── unit/
        └── utils/
            └── date.test.ts
```

### 5.2 E2Eテスト

```
web/e2e/
├── fixtures/
├── page-objects/
├── seeds/
├── tests/
└── utils/
```

---

## 6. モックの使い分け

### モックすべきもの

| 対象 | 理由 |
|------|------|
| 認証（authorizeServerAction） | トークン検証をスキップ |
| 外部サービス（ml-api、メール送信等） | 外部依存を排除 |
| 監査ログ | 副作用を排除 |

### モックすべきでないもの

| 対象 | 理由 |
|------|------|
| データベースアクセス | SQL構文を検証 |
| Prismaクライアント | 実際のクエリ動作を確認 |
| ビジネスロジック関数 | 実装の正確性を検証 |

---

## 7. テストデータ管理

### UUID管理

テストファイル間でのUUID衝突を避けるため、各テストファイルで**固有のUUIDプレフィックス**を使用。

### クリーンアップパターン

| フック | 用途 |
|--------|------|
| `beforeAll` | マスターデータのセットアップ |
| `afterEach` | 各テストで作成したデータのクリーンアップ |
| `afterAll` | マスターデータのクリーンアップ、DB切断 |

---

## 8. 命名規則

- **ファイル名**: `{対象ファイル名}.test.ts`
- **describe**: 対象の関数名またはクラス名
- **it/test**: 日本語で期待する動作を記述

### テストケース

日本語での記述を推奨します。`describe` でグループ化し、`it` で具体的なケースを記述します。

```typescript
describe("getPlans", () => {
  describe("データ取得", () => {
    it("プラン一覧を正しく取得する", ...);
  });
  describe("バリデーション", () => {
    it("無効な入力の場合はエラーを返す", ...);
  });
});
```

---

## 9. ベストプラクティス

- **テストの独立性**: 各テストは他のテストに依存しない
- **Arrange-Act-Assert**: テストデータ準備 → 実行 → 検証 の順で記述
- **エッジケース**: 空データ、境界値、無効入力、エラーケースをテスト
- **Result型**: `success` フラグで分岐してから値を検証

---

## 10. テスト実行

```bash
npm run test                            # 全テスト実行
npm run test -w @delispect/core         # 特定パッケージ
npm run test -- path/to/file            # 特定ファイル
npm run test:watch                      # ウォッチモード
npm run test:coverage                   # カバレッジ付き

# E2Eテスト
npm run e2e                             # 全E2Eテスト
npm run e2e:ui                          # UIモード
```
