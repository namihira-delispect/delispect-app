# DELISPECT - 新システム設計方針（Next Server移行）

## 目次

- [DELISPECT - 新システム設計方針（Next Server移行）](#delispect---新システム設計方針next-server移行)
  - [目次](#目次)
  - [1. 概要](#1-概要)
    - [1.1 目的](#11-目的)
    - [1.2 対象範囲](#12-対象範囲)
    - [1.3 前提](#13-前提)
  - [2. バックエンド設計方針](#2-バックエンド設計方針)
    - [2.1 技術選定サマリ](#21-技術選定サマリ)
    - [2.2 認証（NextAuth / Credentials）](#22-認証nextauth--credentials)
    - [2.3 アプリ本体（Next.js App Router / SSR）](#23-アプリ本体nextjs-app-router--ssr)
    - [2.4 DBアクセス（PostgreSQL + Prisma）](#24-dbアクセスpostgresql--prisma)
    - [2.5 監査設計（3層 + 段階導入）](#25-監査設計3層--段階導入)
    - [2.6 API実装ルール（React-admin連携前提）](#26-api実装ルールreact-admin連携前提)
    - [2.7 非機能要件（バックエンド）](#27-非機能要件バックエンド)
    - [2.8 Django資産からの移行方針](#28-django資産からの移行方針)

## 1. 概要

### 1.1 目的
本書は、既存システムからの変更後アーキテクチャにおける設計方針を定義する。  
本版では、バックエンド（Next Server）を先行して具体化する。

### 1.2 対象範囲
- バックエンド（認証、API、DBアクセス、監査、運用）
- フロントエンド詳細は別紙（`04_frontend_design_consideration.md`）で管理する

### 1.3 前提
- バックエンドは `Next.js App Router` 上で実装する
- DBは `PostgreSQL` を継続利用する
- ORMは `Prisma` を採用する
- 監査は DB層とアプリ層の二重化を前提とし、改ざん検知まで含める

## 2. バックエンド設計方針

### 2.1 技術選定サマリ

| 領域 | 採用技術 | 方針 |
|---|---|---|
| 認証 | NextAuth（Credentials） | ID/パスワード認証に限定し、セッション管理をフレームワーク標準に寄せる |
| アプリ本体 | Next.js（App Router / SSR） | APIと画面を同一アプリで運用し、認証・監査・DB更新を統合する |
| DBアクセス | PostgreSQL + Prisma | 型安全なクエリとマイグレーションを標準化し、更新と監査をトランザクションで一体化する |
| 監査（DB） | pgAudit | アプリを経由しないSQLも含め、網羅的に証跡を残す |
| 監査（アプリ） | audit_logs（JSONB） | 「誰が何をしたか」を検索・可視化しやすい形式で保存する |
| 改ざん検知 | hash + prev_hash（連鎖ハッシュ） | レコード削除・順序改変・内容改ざんを検知可能にする |
| 履歴強化（初期リリース検討） | Temporal Tables | 初期リリースで導入可否を検討し、過去状態復元の強化を図る |

### 2.2 認証（NextAuth / Credentials）

#### 採用理由
- Next.js との統合が自然で、セッション管理を安定して運用できる
- OAuth要件がないため、Credentialsのみで構成を簡素化できる
- 小規模システムに必要な認証機能を過不足なく満たす

#### 設計方針
- 認証方式: `ID + パスワード`（内部ユーザーのみ）
- パスワード: `Argon2id` もしくは `bcrypt` のハッシュで保存（平文禁止）
- セッション: `DB Session` を採用し、セッション実体をDBで管理する（Cookieは`HttpOnly`で運用）
- 認可: ロール情報（例: `admin`, `operator`, `auditor`）をセッションに付与しAPIで検証
- 監査連携: 認証成功/失敗、ログアウトを監査イベントとして記録

#### 最低限のセキュリティ要件
- ログイン試行回数制限（ブルートフォース対策）
- パスワードポリシーは現行運用を維持する（強度要件の再定義は別途）
- セッション有効期限とアイドルタイムアウトの設定

### 2.3 アプリ本体（Next.js App Router / SSR）

#### 採用理由
- サーバーサイドでDB操作を完結しやすい
- 認証・監査を同一アプリ内で統合可能
- React-admin と親和性が高く、管理機能を構築しやすい

#### 設計方針
- 更新系・参照系ともに `API` 経由に一本化し、`Server Actions` は利用しない
  - 監査ログ記録ポイントをAPI層に集約でき、監査実装と運用を単純化できるため
- `app/api/**/route.ts` をAPIエンドポイントとして構築
- ビジネスロジックは `services` 層に集約し、Route Handlerから直接Prismaを多用しない
- 監査必須操作（作成・更新・削除）は共通ユースケース経由で実行
- エラーレスポンスはフォーマットを統一し、監査IDを返却可能にする

#### レイヤ構成（推奨）
- Route Handler層: 認証確認、入力検証、レスポンス整形
- Service層: 業務ルール、更新単位の制御
- Repository層: Prisma経由の永続化
- Audit層: 監査ログ記録・連鎖ハッシュ計算

### 2.4 DBアクセス（PostgreSQL + Prisma）

#### 採用理由
- 既存Django資産がPostgreSQLのため移行相性がよい
- Prismaで型安全な実装を維持しやすい
- `$transaction` で業務更新と監査ログを同一コミットで保証できる

#### 設計方針
- Prisma schemaを唯一のアプリ側データモデル定義とする
- マイグレーションは `prisma migrate` で履歴管理し、SQLレビューを実施
- 作成/更新/削除と監査ログ書き込みは同一 `$transaction` で実行
- 参照系APIは必要最小限の `select` を徹底し、過取得を避ける

### 2.5 監査設計（3層 + 段階導入）

#### 2.5.1 DBレイヤ監査（pgAudit）

##### 採用理由
- SQLレベルで網羅的に記録できる
- アプリを通らない更新も追跡できる
- 法的証跡の裏取りとして強い

##### 方針
- 本番DBで `pgaudit.log` を有効化
- 対象操作（READ/WRITE/DDL/ROLE）は要件に合わせて段階設定
- ログ保全期間は `5年` とし、ローテーションとアクセス権を運用設計に明記

#### 2.5.2 アプリレイヤ監査（audit_logs）

##### 採用理由
- ユーザー視点で理解しやすい監査ログを残せる
- React-adminでの検索・表示に適している
- diff / before / after を柔軟に設計できる

##### 方針
- `audit_logs` は append-only（更新・削除禁止）で運用
- JSONBで `before`, `after`, `diff`, `context` を保持
- 保存期間は `5年` とし、期限経過後のアーカイブ/削除手順を運用に定義する
- 最低限保持する属性:
  - actor（誰が）
  - action（何を）
  - target_type / target_id（何に対して）
  - occurred_at（いつ）
  - request_id / ip / user_agent（どの経路で）

#### 2.5.3 改ざん防止（連鎖ハッシュ）

##### 採用理由
- 監査レコードの削除・改ざん・順序入れ替えを検知しやすい
- WORM保管で防げない「生成時改ざん」を補完できる
- 実装コストに対して効果が高い

##### 方針
- 監査ログ挿入時に `prev_hash` と `hash` を保存する
- `hash = SHA-256(prev_hash + canonical_json(payload))` を基本式とする
- 日次でハッシュ整合性検証ジョブを実行し、異常は即時通知する

#### 2.5.4 全テーブル履歴（Temporal Tables: 初期リリース検討）

##### 採用理由
- 過去状態の完全復元に有効
- Django Simple Historyに近い安心感を提供
- アプリを通らない更新にも対応しやすい

##### 方針
- 初期リリースのスコープとして導入可否を検討し、導入時は対象テーブルを限定する（重要業務テーブル優先）
- 監査要件・運用コストを評価し、段階的に展開する

### 2.6 API実装ルール（React-admin連携前提）

- 一覧取得: ページング・ソート・フィルタを標準対応
- 更新系: 成功時に必ず監査IDを発行しレスポンスに含める
- 削除: 原則ソフトデリートを優先し、物理削除は権限・理由を必須化
- 監査API: `audit_logs` の検索（期間、actor、action、対象ID）を提供

### 2.7 非機能要件（バックエンド）

- 可用性: DB障害時の復旧手順（バックアップ/リストア）を定義
- 性能: 管理画面の一覧応答を優先し、代表ユースケースでSLOを設定
- セキュリティ: 最小権限、機密情報マスキング、監査ログへのアクセス制御
- 運用性: 構造化ログ（request_id付与）で追跡可能性を確保

### 2.8 Django資産からの移行方針

1. データモデル対応表（Django model -> Prisma model）を作成
2. 認証・ユーザー管理をNextAuth前提へ移行
3. 監査ログを先に実装し、業務更新APIへ順次組み込み
4. 管理画面（React-admin）接続後に監査検索・エクスポートを整備
5. Temporal Tablesは初期リリースで導入可否を判断し、未導入の場合は本番運用後に必要範囲を再評価
