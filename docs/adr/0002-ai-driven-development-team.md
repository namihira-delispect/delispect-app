# ADR-0002: AI駆動開発チーム体制

## ステータス

確認中

## コンテキスト

DELISPECTプロジェクトの開発体制を検討するにあたり、従来のWeb開発チーム構成と新しいAI駆動開発のアプローチを比較検討した。

### 背景

- 従来のWeb開発では「1〜2ピザチーム」（5〜10名程度）が効率的とされてきた
- AI駆動開発の台頭により、**1人の開発者が複数のAIエージェントを統率する**新しいチーム構成が可能になった
- 少人数チームでありながら、高い開発効率を実現する必要がある

### 要件

- 少人数で効率的な開発体制
- 品質を担保しながらスピードを確保
- 医療SaMDとしてのQMS要件への対応

---

## 決定

**後述する体制**を試験的に試してみる。

- 各開発者が特定領域のオーナーシップを持ち、開発からマージまで一貫して担当（ブロッキングの排除）
- 開発者がAIエージェントを統率し、並列開発で生産性を最大化
- 個別の実装タスクは開発者に一任し、PdM/PdOは基盤機能のみ関与
- AIが実装・開発者がレビューする形で従来の1 Approve制相当のチェック体制を維持
- 開発フェーズの最後にQA・静的レビューを実施し、機能全体の品質を担保

---

## チーム構成

### 2.1 全体構成図

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           事業統括                                           │
│                  事業判断・ステークホルダー対応                               │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           PdM/PdO                                            │
│             プロダクト責任者・優先順位決定・開発調整・QA兼任                    │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
            ┌───────────────────────┼───────────────────────┐
            │                       │                       │
            ▼                       ▼                       ▼
┌───────────────────┐   ┌───────────────────┐   ┌───────────────────┐
│   開発者 A        │   │   開発者 B        │   │   開発者 C        │
│                   │   │                   │   │                   │
│  担当サービス:     │   │  担当サービス:     │   │  担当サービス:     │
│  サービスA        │   │  サービスB        │   │  サービスC        │
└─────────┬─────────┘   └─────────┬─────────┘   └─────────┬─────────┘
          │                       │                       │
          ▼                       ▼                       ▼
┌───────────────────┐   ┌───────────────────┐   ┌───────────────────┐
│ AIエージェントチーム│   │ AIエージェントチーム│   │ AIエージェントチーム│
│                   │   │                   │   │                   │
│ 実働エージェント x4│   │ 実働エージェント x4│   │ 実働エージェント x4│
└───────────────────┘   └───────────────────┘   └───────────────────┘

                    ┌───────────────────┐
                    │  QAエンジニア      │
                    │   （PdM兼任）      │
                    │                   │
                    │  品質保証・テスト   │
                    │  戦略策定          │
                    └───────────────────┘
```

### 2.2 従来チームとの比較

| 観点       | 従来型（1-2ピザチーム）        | 本チーム構成                                |
|----------|----------------------|---------------------------------------|
| 人員構成     | PdM/PdO + 開発者 数名     | PdM/PdO + 領域別オーナーシップを持つ開発者 + AIエージェント |
| 実装の担い手   | 開発者が実装               | AIが実装、開発者はレビュー・承認に集中                  |
| 承認フロー    | 他者のApproveが必須（待ちが発生） | 担当開発者が自領域をマージまで完結（ブロッキングなし）           |
| 品質管理     | 人間同士のコードレビュー + QA    | AI実装→開発者レビュー + QA・静的レビューフェーズ          |
| ボトルネック   | 人間間のコミュニケーション・承認待ち   | 開発者のレビュー処理能力・QAフェーズ                   |
| スケーラビリティ | 採用・教育コストが高い          | AIエージェント追加で実装力は拡張可能（ただしレビュー負荷は増加）     |

---

## 3. 役割定義

### 3.1 事業統括

**責務**:

- 事業判断（予算、投資判断）
- ステークホルダー（顧客、医療機関）との折衝
- 機能要件の方向性決定

### 3.2 PdM/PdO

**責務**:

- 機能要件の詳細化・優先順位決定
- プロダクトロードマップの策定・管理
- 開発者間の調整・ブロッカー解消
- リリース判断
- ドキュメント管理: 基本設計・概要設計などプロダクト広範に影響のあるドキュメントの品質管理

**開発者へのタスク管理**:

- プロジェクト管理ツールでバックログを管理し、優先順位を設定
- 機能要件を親チケットとしてPdM/PdOが作成
- 開発者は親チケットの子チケットとして実装タスクを分解（ワークフロー1→2の流れ）
- チケットの粒度は「1エージェントが完結できる単位」を基準とする
- **個別の実装タスクは開発者に一任**し、PdM/PdOは基盤機能（DB設計、セキュリティ、外部連携など）に関わるチケットのみ事前レビューを実施

### 3.3 QAエンジニア

**責務**:

- 開発フェーズ完了後の機能全体を通したQA（動作確認・E2Eテスト）
- テスト戦略の策定・テスト観点の整備

### 3.4 開発者

各開発者は特定領域のオーナーシップを持ち、担当サービスの責任者としてAIエージェントチームを統率する。
オーナーシップにより承認待ちなどのブロッキングを排除し、開発スピードを最大化する。

**共通責務**:

- AIエージェントへのタスク指示・コンテキスト提供
- AIが生成したコードのレビュー・承認
- 担当サービスのPRマージ権限を保持（開発からマージまで一貫して担当）
- アーキテクチャ決定・技術選定
- 他開発者との技術的な調整
- 担当サービスのコード品質の責任
- **ドキュメント管理**: 詳細設計・API仕様など担当サービスの技術ドキュメントの作成・維持

### 3.5 AIエージェント

各AIエージェントチームは、**複数のエージェントが並列でタスクチケットを実行**する構成をとる。
エージェントは役割別に分かれるのではなく、**1エージェントが1チケットを最初から最後まで完結**させる。

#### エージェントの構成

```
開発者
├── エージェント 1 ──→ チケット A（実装→テスト→ドキュメント→PR）
├── エージェント 2 ──→ チケット B（実装→テスト→ドキュメント→PR）
├── エージェント 3 ──→ チケット C（実装→テスト→ドキュメント→PR）
└── エージェント 4 ──→ チケット D（実装→テスト→ドキュメント→PR）
```

#### Claude Code を使用する場合の構成例

| 階層           | 役割                 | 例                                |
|--------------|--------------------|----------------------------------|
| **メインセッション** | 1チケットの開発サイクル全体を管理  | チケット「患者一覧APIの実装」を担当              |
| **サブエージェント** | メインセッション内で特定タスクを実行 | コード探索、テスト実行、ビルド確認                |
| **Skills**   | 定型タスクの自動実行         | `/commit`, `/review-pr`, `/test` |

```
┌─────────────────────────────────────────────────────────────┐
│ メインセッション（チケット単位）                              │
│                                                             │
│  1. 要件理解・設計                                           │
│       └─ サブエージェント: コードベース探索                   │
│  2. 実装                                                    │
│       └─ サブエージェント: 関連ファイル調査                   │
│  3. テスト作成・実行                                         │
│       └─ Skills: /test                                      │
│  4. ドキュメント更新                                         │
│  5. コミット・PR作成                                         │
│       └─ Skills: /commit, /review-pr                        │
└─────────────────────────────────────────────────────────────┘
```

---

## 4. ワークフロー

### 4.1 PdM/PdO ↔ 開発者のタスクフロー

```
┌─────────────────────────────────────────────────────────────────────────┐
│ 1. 要件伝達                                                               │
│    PdM/PdO → 開発者:                                                     │
│    ・機能要件・優先順位を伝達（親チケット作成）                             │
│    ・受け入れ条件の明確化                                                 │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│ 2. タスク分解                                                             │
│    開発者:                                                                │
│    ・親チケットを子チケットに分解（1エージェントが完結できる粒度）           │
│    ・詳細設計（プロンプト・完了条件・テスト観点）を記載                     │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│ 3. 事前レビュー（オプション）                                              │
│    PdM/PdO ↔ 開発者: チケット上で非同期レビュー                           │
│    ・詳細設計の妥当性確認                                                 │
│    ・実行計画の確認                                                       │
│    ・要件との齟齬がないか検証                                              │
│    ※ 基盤機能（DB設計、セキュリティ、外部連携等）や開発者の判断で実施           │
│    ※ 通常の実装タスクは開発者に一任し、本ステップをスキップ可能                  │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│ 4. 開発・レビュー・マージ                                                 │
│    開発者がオーナーシップを持って一貫して担当:                              │
│    ・エージェントへのチケット割り当て・実行（→ 4.2参照）                    │
│    ・PRレビュー・承認・マージ                                              │
│    ※ 担当領域は自身の判断でマージまで完結                                  │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│ 5. 完了報告                                                               │
│    開発者 → PdM/PdO:                                                     │
│    ・親チケットの完了報告                                                 │
│    ・受け入れ条件の充足確認                                               │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
          ※ 開発フェーズが一段落したタイミングで実施
┌─────────────────────────────────────────────────────────────────────────┐
│ 6. QA・静的レビュー                                                       │
│    QAエンジニア:                                                          │
│    ・機能全体を通したQA（動作確認・E2Eテスト）                             │
│    ・重要箇所の静的コードレビュー                                          │
│      （セキュリティ、データ整合性、アーキテクチャ適合性）                    │
│    ※ 指摘事項があれば開発者が修正対応                                      │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│ 7. リリース                                                               │
│    ・mainにリリースタグ（vX.Y.Z）を付与                                   │
│    ・GitHub Releasesでリリースノート作成                                   │
│    ・CIでリリースビルド・成果物を生成                                      │
└─────────────────────────────────────────────────────────────────────────┘
```

### 4.2 エージェントの1チケット実行フロー

要件定義・設計は開発者とエージェントが**対話的**に実施し、合意後にエージェントが自律的に実行する:

```
┌─────────────────────────────────────────────────────────────────────┐
│                    1チケットの開発サイクル                            │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  【対話フェーズ】開発者 ↔ エージェント                                 │
│  ┌──────────────────────────────────────────┐                       │
│  │ 1. 設計理解                               │                       │
│  │    ・要件の確認・質問                      │                       │
│  │    ・既存コードの調査                      │                       │
│  │    ・設計方針の提案・すり合わせ             │                       │
│  └──────────────────────────────────────────┘                       │
│                         │                                           │
│                         ▼                                           │
│  ┌──────────────────────────────────────────┐                       │
│  │ 2. 実行計画                               │                       │
│  │    ・変更ファイル・影響範囲の特定           │                       │
│  │    ・実装ステップの提示                    │                       │
│  │    ・開発者の承認                         │                       │
│  └──────────────────────────────────────────┘                       │
│                         │                                           │
│                         ▼ 承認後                                     │
│  【自律実行フェーズ】エージェント                                      │
│                                                                     │
│  ┌──────────┐   ┌──────────┐   ┌──────────┐   ┌─────────────┐     │
│  │ 3. 実装  │──▶│ 4. テスト │──▶│ 5. コミット│──▶│6. セルフレビュー│     │
│  └──────────┘   └──────────┘   └──────────┘   └──────┬──────┘     │
│       ▲                                              │             │
│       │                    ┌─────────────────────────┤             │
│       │                    │ 指摘あり                 │ OK         │
│       └────────────────────┘                         ▼             │
│                                               ┌──────────┐         │
│                                               │ 7. PR作成 │         │
│                                               └─────┬────┘         │
│                                                     │              │
│                                                     ▼              │
│  ┌──────────────────────────────────────────────────────┐           │
│  │ 8. PRレビュー対応                                     │           │
│  │    ・CodeRabbit・Codex自動レビューへの対応              │           │
│  │    ・人間レビューコメントへの対応                      │           │
│  │    ・指摘事項の修正・追加コミット                      │           │
│  └──────────────────────────────────────────────────────┘           │
│                         │                                           │
│                         ▼ Approve後                                  │
│  ┌──────────────────────────────────────────────────────┐           │
│  │ 9. マージ                                             │           │
│  └──────────────────────────────────────────────────────┘           │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 5. 品質管理

### 5.1 品質保証レベル

人間の工数を効率的に配分するため、プロダクトのフェーズに応じて3段階の品質保証レベルを設定する。

**前提**: 基本設計（テーブル定義、API設計、アーキテクチャ）は事前に人間がレビュー済み

| レベル  | フェーズ        | 保証内容                                             |
|------|-------------|--------------------------------------------------|
| Lv.1 | プロトタイプ・PoC  | ブラックボックステスト（手動動作確認 + E2E）<br>※一部クリティカルな機能はレビュー対象 |
| Lv.2 | ベータ版（PMF検証） | Lv.1 + 重要箇所のコードレビュー + 必要に応じて他開発者へレビュー依頼          |
| Lv.3 | 製品版（PMF後）   | Lv.1 + 可能な限りコードレビュー + リリース前に重要機能の第三者レビュー         |

> **本製品版ではLv.2を適用する。** 重要箇所のコードレビューを実施し、必要に応じて他開発者へレビューを依頼する。

### 5.2 品質ゲート

| ゲート      | 条件                   | 担当            |
|----------|----------------------|---------------|
| PR作成前    | Lintパス、型チェックパス、テストパス | エージェント（自動）    |
| PR作成     | セルフレビュー完了、完了条件を満たす   | エージェント        |
| E2E/動作確認 | 手動確認 or E2Eテストパス     | 担当開発者（Lv.1以上） |
| コードレビュー  | 開発者Approve           | 担当開発者（Lv.2以上） |
| 他開発者レビュー | 必要に応じて依頼・Approve     | 他開発者（Lv.2、任意） |
| 第三者レビュー  | 重要機能のリリース前確認         | 他開発者（Lv.3、必須） |
| CI       | 全テストパス               | 自動            |
| マージ      | 該当レベルのゲート通過          | 担当開発者         |

### 5.3 クリティカル箇所の定義

以下に該当する場合、レベルに関わらずレビューを実施:

- セキュリティに関わる箇所（認証・認可、入力検証）
- 個人情報・医療データの取り扱い
- 外部システム連携
- データベーススキーマの変更

---

## 6. ナレッジ管理

### 6.1 AIエージェントへのコンテキスト共有

効率的なAI活用のため、以下のドキュメントを整備・維持する:

| ドキュメント       | 目的        | 更新頻度    |
|--------------|-----------|---------|
| コーディングガイドライン | コード規約の統一  | 随時      |
| アーキテクチャ設計書   | 全体構成の理解   | 機能追加時   |
| API仕様書       | エンドポイント定義 | API変更時  |
| テーブル定義書      | DB構造の理解   | スキーマ変更時 |
| 用語集          | ドメイン知識    | 随時      |

### 6.2 CLAUDE.md / .claude/ 構成

```
.claude/
├── CLAUDE.md                    # プロジェクトコンテキスト（規約、構成、用語）
├── commands/                    # カスタムスラッシュコマンド
│   ├── create-component.md      # /create-component
│   ├── create-server-action.md  # /create-server-action
│   └── create-test.md           # /create-test
└── settings.json                # プロジェクト設定
```

---

## 7. SaMD QMSとの対応

薬機法に基づくQMS体制の役割のうち、開発フローに関係するものと本チームの対応関係:

| QMS役割       | 責務              | 本チームでの役割 |
|-------------|-----------------|----------|
| 管理監督者       | QMS全体の最終責任、経営判断 | 事業統括     |
| 管理責任者       | QMSの運用管理・維持     | PdM/PdO  |
| 国内品質業務運営責任者 | 品質管理業務の統括       | QA       |

**補足**:

- AIエージェントは開発支援ツールとして活用。QMS上の責任は人間が保持
- Lv.3（製品版）では検証者・レビューアの独立性を担保

---

## 理由

### AI駆動開発を選んだ理由

1. **開発効率の向上**
    - 各開発者に領域のオーナーシップを付与し、承認待ちのブロッキングを排除
    - AIエージェントの並列実行で、少人数でも高い生産性を実現
    - 定型的な実装作業をAIに委譲し、人間は設計・レビューに集中

2. **品質の担保**
    - 開発フェーズの最後にQA・静的レビューフェーズを設け、機能全体の品質を確保
    - AIが実装し開発者がレビュー・承認する形で、従来の1 Approve制と同等のチェック体制を維持
    - 必要に応じて他開発者によるレビューも実施し、品質保証レベル（Lv.1〜3）でその負荷をコントロール

3. **スケーラビリティ**
    - AIエージェント追加で即座に開発リソースを拡張可能
    - 採用・教育コストを抑制

---

## 影響

### ポジティブな影響

- 少人数チームでの高い開発生産性
- 人間は高度な判断（設計、レビュー）に集中できる
- 品質保証レベルによる柔軟な品質管理

### ネガティブな影響・リスク

| リスク          | 対策                  |
|--------------|---------------------|
| AIの出力品質のばらつき | 品質ゲート、人間によるレビュー     |
| AIへの過度な依存    | 重要箇所は人間が必ずレビュー      |
| QMS要件への適合    | AIは開発支援ツール、責任は人間が保持 |

### 必要な対応

- チケット記述ガイドラインの整備（AIが理解しやすい形式）
- Skillsなど手順の再現性の整備
- 品質ゲートの自動化（CI/CD）

---

## 関連情報

- 関連ADR: [ADR-0001](./0001-monorepo-typescript.md) - Monorepo + TypeScript統一
- 関連ドキュメント:
    - [開発フロー](../development-workflows/development-flow.md)
    - [チケット記述ガイドライン](../development-workflows/ticket-writing.md)
