# ADR-0003: ML推論の同期API方式

## ステータス

確認中

## コンテキスト

DELISPECTのML推論（せん妄リスク予測）の呼び出し方式を決定する必要がある。

### 前提条件

- ML推論はPython独立サービスとして稼働する（ADR-0001）
- Next.jsとMLはDockerコンテナが分かれており、通信はHTTPで行う
- 患者データの更新には2つの経路がある:
  - **バッチインポート**: 電子カルテからの日次/オンデマンド取り込み
  - **手動更新**: ユーザー（医師/看護師）による画面上からの更新
- 推論のレスポンスタイム目標は5秒以内

---

## 検討した選択肢

### 選択肢1: 同期API方式

**概要**:
ML推論をHTTP APIとして常駐させ、Server Actionから同期的に呼び出す。レスポンスで予測結果を受け取り、DBに格納して画面に反映する。

```
手動更新 → Server Action → ML API（HTTP同期） → 結果をDBに格納 → 画面に反映
```

**メリット**:
- 実装がシンプル（状態管理不要）
- ユーザーに即座に結果を表示できる
- エラーハンドリングが容易（同期的にResult型で返却）

**デメリット**:
- 推論が重くなるとリクエストタイムアウトのリスク
- MLプロセスが常駐するためリソースを消費

### 選択肢2: 非同期バッチ方式

**概要**:
ML推論をバッチ処理として実行する。データ更新時にトリガーし、結果はDBに書き込む。画面はポーリングやリロードで結果を取得する。

```
手動更新 → Server Action → ML予測をトリガー → 画面は「予測中」表示
                                              → MLがDBに結果を書き込み
                                              → ポーリングで結果を取得
```

**メリット**:
- 長時間の推論処理に対応可能
- MLコンテナをオンデマンド起動でき、リソース効率が良い

**デメリット**:
- 「予測中」ステートの管理が必要（フロントエンド・バックエンド双方）
- ポーリングまたはWebSocket等の仕組みが必要
- 実装・テストの複雑さが増す

---

## 決定

**選択肢1: 同期API方式** の方針。

---

## 理由

1. **まず同期方式で検証する**
   - リスク予測モデルはdeep learningを採用予定であり、推論時間は現時点で未確定
   - まず同期APIで実装し、推論時間が5秒以内に収まるか検証する
   - 超過する場合は非同期バッチ方式へ移行する（将来の移行パス参照）

2. **実装のシンプルさ**
   - 非同期方式は予測中ステート管理・ポーリング・エラーリカバリなどの追加実装が必要
   - 同期方式はServer ActionからfetchしてResult型で返すだけで完結する

3. **手動更新のUX**
   - ユーザーがデータを更新した直後に予測結果が表示される方が自然
   - 「予測中...」→後から反映、のUXは現時点では不要な複雑さ

---

## 影響

### ポジティブな影響

- シンプルなデータフロー（同期的なリクエスト/レスポンス）
- 状態管理の複雑さを回避
- 開発・テスト工数の削減

### ネガティブな影響・リスク

| リスク | 対策 |
|--------|------|
| deep learningモデルの推論時間が5秒を超える場合 | 非同期バッチ方式への移行を検討（下記参照） |
| MLプロセス常駐によるリソース消費 | 単一サーバー（16GB RAM）の規模では影響は限定的 |

### 将来の移行パス

deep learningモデルの推論時間が5秒以内の目標を達成できないことが判明した場合、非同期バッチ方式への移行を検討する。移行時の主な変更:

- ML APIにトリガーエンドポイントを追加（または既存エンドポイントを非同期化）
- 予測ステータス（pending / completed / failed）をDBに追加
- フロントエンドにポーリングまたはリロードによる結果取得を追加

---

## 関連情報

- 関連ADR: [ADR-0001](./0001-monorepo-typescript.md) - Monorepo + TypeScript統一（ML除く）
- 関連ドキュメント: [システムアーキテクチャ設計書](../design/01_system_architecture.md)
