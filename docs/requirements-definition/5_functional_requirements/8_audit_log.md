# 8.監査ログ

## 機能概要
医療情報セキュリティガイドラインに準拠した監査ログ機能を提供する。システムの利用状況や操作履歴を記録し、不正アクセスの検知や追跡を可能にする。

## 前提条件
- ログの閲覧・管理はシステム管理者または全権管理者に限定される

## 機能要件

### 8.1 ログ記録機能

#### 8.1.1 利用者アクセス情報の記録
- ログイン時刻の記録
- ログアウト時刻の記録
- アクセス時間の記録
- アクセス元のIPアドレスの記録

#### 8.1.2 操作内容の記録
以下の操作を記録する：
- データの閲覧
- データの登録
- データの更新
- データの削除
- システム設定の変更

#### 8.1.3 操作対象情報の記録
以下の情報を記録する：
- 患者入院ID
- リスク評価操作の詳細
- 電子カルテデータ連携操作の詳細

#### 8.1.4 利用者情報の記録
以下の情報を記録する：
- ユーザーID
- 権限レベル

#### 8.1.5 時刻情報の記録
- 操作日時（年/月/日 時:分:秒）
- タイムゾーン情報
- 時刻同期状態

#### 8.1.6 非常時用アカウントの操作記録
- 非常時用アカウントによるログイン・操作を通常アカウントと区別して記録する
- 非常時用アカウントが使用された場合、使用事実・操作内容・使用理由を記録する

### 8.2 ログ管理機能

#### 8.2.1 ログの保存
- ログデータの暗号化保存
- ログファイルのバックアップ
- ログデータの圧縮保存

#### 8.2.2 ログの保護
- ログデータへのアクセス制限
- ログデータの改ざん防止
- ログデータの削除防止

#### 8.2.3 個人情報のマスキング
監査ログは追跡性を担保するため保存データにはIDを原本のまま保持するが、表示・エクスポート時に個人情報をマスキングする。

- 患者氏名はログ表示時にマスキング（例：「山○太○」）
- ユーザー氏名はログ表示時にマスキング
- 管理者権限を持つユーザーが調査目的で閲覧する場合のみマスキング解除可能とする
- ログのエクスポート時は個人情報をマスキングした状態で出力する

#### 8.2.4 ログの確認
- ログファイルを直接確認

### 8.3 ログ監視機能
#### 8.3.1 定期的なログ確認
- 週次ログ確認機能
- 月次ログ確認機能

#### 8.3.2 異常検知
- 不正アクセスパターンの検知

### 8.4 ログ検索・フィルタリング機能
#### 8.4.1 検索条件
- 期間指定検索（開始日時〜終了日時）
- ユーザーID検索（部分一致対応）
- 操作種別検索（複数選択可能）
- 患者ID検索
- IPアドレス検索
- フリーワード検索

#### 8.4.2 フィルタリング機能
- 検索結果の絞り込み
- ソート機能（日時、ユーザー、操作種別）
- ページネーション機能
- 検索条件の保存・再利用

## 非機能要件

### 8.5 セキュリティ要件
- ログデータの暗号化
- アクセス権限の厳格な管理
- ログデータの改ざん防止
- ログデータのバックアップ

### 8.6 運用要件
- ログデータの保持期間：5年間
- バックアップの頻度：日次
- ログ確認の頻度：日次
- システム管理者による定期監査
- NTPサーバとの時刻同期を必須とし、全サーバ・コンテナの時刻を統一する
- 時刻同期の逸脱が発生した場合、日次のログ確認時に検出可能とする

### 8.7 監査体制要件
- システム運用担当者以外の第三者による内部監査を定期的に実施可能とする
- 内部監査に必要なログのエクスポート・提供機能を備える
- 外部機関による監査実施時にログデータを提供できる体制を維持する

## 制約条件
- 医療情報セキュリティガイドラインへの準拠
- 電子カルテシステムとの連携要件
- 病院のセキュリティポリシーへの準拠
- ログデータの容量制限
- 外部委託時の責任分界点の明確化

## エラー処理
- ログ記録失敗時は業務操作に影響を与えないこと（ログ欠損を許容）
- ログ記録失敗自体をシステムログに記録する
- ログ記録の失敗が継続する場合、日次のログ確認時に管理者が検出できるようにする
- システム障害等によりログ記録が不可能な期間が発生した場合、運用手順書に基づき業務日誌等での代替記録を実施する
